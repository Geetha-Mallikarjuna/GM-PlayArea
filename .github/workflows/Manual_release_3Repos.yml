name: Manual Release for 3 Fixed Repos with Changelog Summary

on:
  workflow_dispatch:
    inputs:
      from_tag_1:
        description: 'From tag for Repo 1'
        required: true
      to_tag_1:
        description: 'To tag for Repo 1'
        required: true
      title_1:
        description: 'Release title for Repo 1 (optional)'
        required: false

      from_tag_2:
        description: 'From tag for Repo 2'
        required: true
      to_tag_2:
        description: 'To tag for Repo 2'
        required: true
      title_2:
        description: 'Release title for Repo 2 (optional)'
        required: false

      from_tag_3:
        description: 'From tag for Repo 3'
        required: true
      to_tag_3:
        description: 'To tag for Repo 3'
        required: true
      title_3:
        description: 'Release title for Repo 3 (optional)'
        required: false

jobs:
  create-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.PERSONAL_TOKEN }}"
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

      - name: Create releases and collect changelogs
        run: |
          mkdir changelogs

          # Define fixed repos
          REPOS=(
            "Geetha-Mallikarjuna/GM-PlayArea"
            "Geetha-Mallikarjuna/GM-PlayArea-2"
            "Geetha-Mallikarjuna/GM-PlayArea-3"
          )

          # Inputs from workflow_dispatch
          FROM_TAGS=(
            "${{ inputs.from_tag_1 }}"
            "${{ inputs.from_tag_2 }}"
            "${{ inputs.from_tag_3 }}"
          )
          TO_TAGS=(
            "${{ inputs.to_tag_1 }}"
            "${{ inputs.to_tag_2 }}"
            "${{ inputs.to_tag_3 }}"
          )
          TITLES=(
            "${{ inputs.title_1 }}"
            "${{ inputs.title_2 }}"
            "${{ inputs.title_3 }}"
          )

          for i in 0 1 2; do
            REPO="${REPOS[$i]}"
            FROM="${FROM_TAGS[$i]}"
            TO="${TO_TAGS[$i]}"
            TITLE="${TITLES[$i]}"

            if [[ -z "$TITLE" ]]; then
              TITLE="Release $TO"
            fi

            echo "ðŸ“¦ Generating release notes for $REPO: $FROM â†’ $TO"

            NOTES=$(gh api repos/$REPO/releases/generate-notes \
              -f tag_name="$TO" \
              -f previous_tag_name="$FROM" \
              -q .body)

            if [[ -z "$NOTES" ]]; then
              echo "âš ï¸ Could not generate release notes for $REPO"
              continue
            fi

            # Save changelog
            FILE="changelogs/changelog-${REPO//\//_}.txt"
            echo "ðŸ”– $REPO: $FROM â†’ $TO" > "$FILE"
            echo "" >> "$FILE"
            echo "$NOTES" >> "$FILE"

            # Save notes for release creation
            echo "$NOTES" > notes.txt

            echo "ðŸš€ Creating release $TO in $REPO"
            gh release create "$TO" \
              --repo "$REPO" \
              --title "$TITLE" \
              --notes-file notes.txt

            echo "âœ… Release created: $REPO@$TO"
          done

          echo "ðŸ“‹ Combined changelogs:"
          cat changelogs/* > changelogs/changelogs-summary.txt
          cat changelogs/changelogs-summary.txt
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

      - name: Upload changelogs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelogs
          path: changelogs
